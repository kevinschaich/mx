<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MX Dialpad Configuration</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    h1 {
      color: white;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }
    
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .card h2 {
      margin-bottom: 16px;
      color: #333;
      font-size: 1.5em;
      border-bottom: 2px solid #667eea;
      padding-bottom: 8px;
    }
    
    .status {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #ff4d4f;
      animation: pulse 2s infinite;
    }
    
    .status-dot.connected {
      background: #52c41a;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    button.primary {
      background: #667eea;
      color: white;
    }
    
    button.danger {
      background: #ff4d4f;
      color: white;
    }
    
    button.success {
      background: #52c41a;
      color: white;
    }
    
    .mapping-item {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      align-items: center;
    }
    
    .mapping-item input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #d9d9d9;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .mapping-item input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .mapping-item button {
      padding: 8px 12px;
    }
    
    .add-mapping {
      margin-top: 16px;
    }
    
    .log {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: 8px;
      font-family: 'Monaco', 'Courier New', monospace;
      font-size: 13px;
      max-height: 500px;
      overflow-y: auto;
      line-height: 1.6;
    }
    
    .log-entry {
      margin-bottom: 12px;
      padding: 8px;
      background: #2d2d2d;
      border-radius: 4px;
      border-left: 3px solid #667eea;
    }
    
    .log-entry.button {
      border-left-color: #52c41a;
    }
    
    .log-entry.scroll {
      border-left-color: #faad14;
    }
    
    .log-entry.known {
      background: #1f3a1f;
      border-left-width: 4px;
    }
    
    .timestamp {
      color: #888;
      font-size: 11px;
    }
    
    .event-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-right: 8px;
    }
    
    .event-badge.button { background: #52c41a; color: white; }
    .event-badge.scroll { background: #faad14; color: white; }
    .event-badge.value { background: #1890ff; color: white; }
    
    .log-actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .log-actions button {
      padding: 4px 10px;
      font-size: 11px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    
    .log-actions button:hover {
      background: #5568d3;
    }
    
    .log-actions input {
      padding: 4px 8px;
      font-size: 12px;
      border: 1px solid #555;
      border-radius: 4px;
      background: #1e1e1e;
      color: #d4d4d4;
      width: 150px;
    }
    
    .log-actions input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: #52c41a;
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      font-weight: 600;
    }
    
    .toast.warning {
      background: #faad14;
    }
    
    .toast.error {
      background: #ff4d4f;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    .clear-log {
      margin-top: 12px;
    }
    
    .full-width {
      grid-column: 1 / -1;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üéõÔ∏è MX Dialpad Configuration</h1>
    
    <div class="grid">
      <!-- Status Card -->
      <div class="card">
        <h2>Device Status</h2>
        <div class="status">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusText">Disconnected</span>
        </div>
        <p>Reports received: <strong id="reportCount">0</strong></p>
      </div>
      
      <!-- Jog Wheel Visualization -->
      <div class="card">
        <h2>Jog Wheel Position</h2>
        <div style="text-align: center;">
          <svg width="200" height="200" style="margin: 0 auto; display: block;">
            <circle cx="100" cy="100" r="80" fill="none" stroke="#e0e0e0" stroke-width="10"/>
            <circle id="jogProgress" cx="100" cy="100" r="80" fill="none" stroke="#667eea" stroke-width="10"
                    stroke-dasharray="502.65" stroke-dashoffset="502.65"
                    transform="rotate(-90 100 100)" stroke-linecap="round"/>
            <text x="100" y="100" text-anchor="middle" dy=".3em" font-size="24" font-weight="bold" fill="#333" id="jogPosition">0</text>
          </svg>
          <div style="margin-top: 12px; display: flex; justify-content: space-around;">
            <div>
              <div style="font-size: 11px; color: #999;">Total Scrolls</div>
              <div style="font-size: 18px; font-weight: bold;" id="jogScrolls">0</div>
            </div>
            <div>
              <div style="font-size: 11px; color: #999;">Last Speed</div>
              <div style="font-size: 18px; font-weight: bold;" id="jogSpeed">‚Äî</div>
            </div>
            <div>
              <div style="font-size: 11px; color: #999;">Highest Speed</div>
              <div style="font-size: 18px; font-weight: bold; color: #ff4d4f;" id="jogHighestSpeed">0</div>
            </div>
            <div>
              <div style="font-size: 11px; color: #999;">Direction</div>
              <div style="font-size: 18px; font-weight: bold;" id="jogDirection">‚Äî</div>
            </div>
          </div>
          <button onclick="resetJogPosition()" style="margin-top: 12px; padding: 6px 16px; font-size: 12px; background: #faad14; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Reset Position
          </button>
        </div>
      </div>
      
      <!-- Scroll Wheel Visualization -->
      <div class="card">
        <h2>Scroll Wheel Position</h2>
        <div style="text-align: center;">
          <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
            <div style="position: relative; width: 40px; height: 300px; background: #e0e0e0; border-radius: 20px; overflow: hidden;">
              <div id="scrollProgress" style="position: absolute; bottom: 0; width: 100%; background: linear-gradient(to top, #52c41a, #91d5ff); transition: height 0.1s ease-out; height: 50%;"></div>
              <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 100%; background: rgba(0,0,0,0.2);"></div>
            </div>
            <div style="text-align: left;">
              <div style="margin-bottom: 12px;">
                <div style="font-size: 32px; font-weight: bold;" id="scrollPosition">0</div>
                <div style="font-size: 11px; color: #999;">Position</div>
              </div>
              <div style="margin-bottom: 12px;">
                <div style="font-size: 18px; font-weight: bold;" id="scrollScrolls">0</div>
                <div style="font-size: 11px; color: #999;">Total Scrolls</div>
              </div>
              <div style="margin-bottom: 12px;">
                <div style="font-size: 18px; font-weight: bold;" id="scrollSpeed">‚Äî</div>
                <div style="font-size: 11px; color: #999;">Last Speed</div>
              </div>
              <div style="margin-bottom: 12px;">
                <div style="font-size: 18px; font-weight: bold; color: #ff4d4f;" id="scrollHighestSpeed">0</div>
                <div style="font-size: 11px; color: #999;">Highest Speed</div>
              </div>
              <div style="margin-bottom: 12px;">
                <div style="font-size: 18px; font-weight: bold;" id="scrollDirection">‚Äî</div>
                <div style="font-size: 11px; color: #999;">Direction</div>
              </div>
            </div>
          </div>
          <button onclick="resetScrollPosition()" style="margin-top: 12px; padding: 6px 16px; font-size: 12px; background: #faad14; color: white; border: none; border-radius: 4px; cursor: pointer;">
            Reset Position
          </button>
        </div>
      </div>
      
      <!-- Buttons Mapping -->
      <div class="card">
        <h2>Button Mappings</h2>
        <div id="buttonMappings"></div>
        <div class="add-mapping">
          <input type="number" id="newButtonByte" placeholder="Byte" style="width: 70px;">
          <input type="number" id="newButtonBit" placeholder="Bit (optional)" style="width: 100px;">
          <input type="text" id="newButtonName" placeholder="Button name">
          <button class="primary" onclick="addButtonMapping()">Add</button>
        </div>
      </div>
      
      <!-- Scroll Wheel Mapping -->
      <div class="card">
        <h2>Scroll Wheel Mappings</h2>
        <div id="scrollMappings"></div>
        <div class="add-mapping">
          <input type="number" id="newScrollByte" placeholder="Byte index" style="width: 100px;">
          <input type="text" id="newScrollName" placeholder="Wheel name">
          <button class="primary" onclick="addScrollMapping()">Add</button>
        </div>
      </div>
      
      <!-- Actions -->
      <div class="card">
        <h2>Actions</h2>
        <p style="font-size: 13px; color: #666; margin-bottom: 12px;">
          üí° Quick-add from logs auto-saves! Use this button if you manually edit mappings above.
        </p>
        <button class="success" onclick="saveConfig()">üíæ Save Configuration</button>
        <button class="danger" onclick="clearConfig()">üóëÔ∏è Clear All Mappings</button>
      </div>
      
      <!-- Live Log -->
      <div class="card full-width">
        <h2>Live Event Log</h2>
        <div class="log" id="log"></div>
        <button class="primary clear-log" onclick="clearLog()">Clear Log</button>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let config = { buttons: {}, scrollWheels: {} };
    let logEntries = [];
    const MAX_LOG_ENTRIES = 100;
    let jogWheelData = {
      position: 0,
      totalScrolls: 0,
      lastDirection: null,
      highestSpeed: 0,
      currentSeriesHighest: 0,
      debounceTimer: null
    };
    let scrollWheelData = {
      position: 0,
      totalScrolls: 0,
      lastDirection: null,
      highestSpeed: 0,
      currentSeriesHighest: 0,
      debounceTimer: null
    };
    
    // Socket events
    socket.on('connect', () => {
      console.log('Connected to server');
    });
    
    socket.on('config', (data) => {
      config = data;
      renderMappings();
    });
    
    socket.on('status', (data) => {
      updateStatus(data);
    });
    
    socket.on('report', (report) => {
      updateLog(report);
    });
    
    // Update status
    function updateStatus(status) {
      const dot = document.getElementById('statusDot');
      const text = document.getElementById('statusText');
      const count = document.getElementById('reportCount');
      
      if (status.connected) {
        dot.classList.add('connected');
        text.textContent = 'Connected';
      } else {
        dot.classList.remove('connected');
        text.textContent = 'Disconnected';
      }
      
      count.textContent = status.reportCount;
    }
    
    // Render mappings
    function renderMappings() {
      const buttonContainer = document.getElementById('buttonMappings');
      const scrollContainer = document.getElementById('scrollMappings');
      
      buttonContainer.innerHTML = '';
      scrollContainer.innerHTML = '';
      
      Object.entries(config.buttons || {}).forEach(([key, name]) => {
        const displayKey = key.includes(':') ? `Byte ${key.split(':')[0]} bit ${key.split(':')[1]}` : `Byte ${key}`;
        buttonContainer.innerHTML += `
          <div class="mapping-item">
            <input type="text" value="${displayKey}" disabled style="width: 150px;">
            <input type="text" value="${name}" onchange="updateButtonMapping('${key}', this.value)">
            <button class="danger" onclick="removeButtonMapping('${key}')">‚úï</button>
          </div>
        `;
      });
      
      Object.entries(config.scrollWheels || {}).forEach(([byte, name]) => {
        scrollContainer.innerHTML += `
          <div class="mapping-item">
            <input type="text" value="Byte ${byte}" disabled style="width: 100px;">
            <input type="text" value="${name}" onchange="updateScrollMapping(${byte}, this.value)">
            <button class="danger" onclick="removeScrollMapping(${byte})">‚úï</button>
          </div>
        `;
      });
    }
    
    // Add mappings
    function addButtonMapping() {
      const byte = document.getElementById('newButtonByte').value;
      const bit = document.getElementById('newButtonBit').value;
      const name = document.getElementById('newButtonName').value;
      
      if (byte && name) {
        const key = bit ? `${byte}:${bit}` : byte;
        config.buttons[key] = name;
        document.getElementById('newButtonByte').value = '';
        document.getElementById('newButtonBit').value = '';
        document.getElementById('newButtonName').value = '';
        renderMappings();
      }
    }
    
    function addScrollMapping() {
      const byte = document.getElementById('newScrollByte').value;
      const name = document.getElementById('newScrollName').value;
      
      if (byte && name) {
        config.scrollWheels[byte] = name;
        document.getElementById('newScrollByte').value = '';
        document.getElementById('newScrollName').value = '';
        renderMappings();
      }
    }
    
    // Update mappings
    function updateButtonMapping(key, name) {
      config.buttons[key] = name;
    }
    
    function updateScrollMapping(byte, name) {
      config.scrollWheels[byte] = name;
    }
    
    // Remove mappings
    function removeButtonMapping(key) {
      delete config.buttons[key];
      renderMappings();
    }
    
    function removeScrollMapping(byte) {
      delete config.scrollWheels[byte];
      renderMappings();
    }
    
    // Save config
    async function saveConfig() {
      const response = await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      });
      
      if (response.ok) {
        showToast('‚úÖ Configuration saved successfully!');
      } else {
        showToast('‚ùå Failed to save configuration', 'error');
      }
    }
    
    // Clear config
    function clearConfig() {
      if (confirm('‚ö†Ô∏è Are you sure you want to clear all mappings?\n\nThis will remove all button and scroll wheel mappings.\n\nDon\'t forget to save after clearing!')) {
        config = { buttons: {}, scrollWheels: {} };
        renderMappings();
        showToast('üóëÔ∏è All mappings cleared (save to persist)');
      }
    }
    
    // Update jog wheel visualization
    function updateJogWheel(event) {
      // Update position
      jogWheelData.position = event.position;
      jogWheelData.totalScrolls++;
      jogWheelData.lastDirection = event.direction;
      
      // Track highest speed in current series
      if (event.amount > jogWheelData.currentSeriesHighest) {
        jogWheelData.currentSeriesHighest = event.amount;
        jogWheelData.highestSpeed = event.amount;
        document.getElementById('jogHighestSpeed').textContent = event.amount;
      }
      
      // Clear existing debounce timer
      if (jogWheelData.debounceTimer) {
        clearTimeout(jogWheelData.debounceTimer);
      }
      
      // Set new debounce timer - reset series after 250ms of no movement
      jogWheelData.debounceTimer = setTimeout(() => {
        jogWheelData.currentSeriesHighest = 0;
      }, 250);
      
      // Update position text
      document.getElementById('jogPosition').textContent = event.position;
      
      // Update progress circle (wrap around at 360)
      const normalizedPos = ((event.position % 360) + 360) % 360;
      const circumference = 502.65; // 2 * PI * 80
      const offset = circumference - (normalizedPos / 360) * circumference;
      document.getElementById('jogProgress').style.strokeDashoffset = offset;
      
      // Update stats
      document.getElementById('jogScrolls').textContent = jogWheelData.totalScrolls;
      document.getElementById('jogDirection').textContent = event.direction === 'up' ? '‚Üë' : '‚Üì';
      document.getElementById('jogDirection').style.color = event.direction === 'up' ? '#52c41a' : '#ff4d4f';
      
      // Update speed
      document.getElementById('jogSpeed').textContent = event.amount;
      const speedColor = event.amount > 50 ? '#ff4d4f' : event.amount > 20 ? '#faad14' : '#52c41a';
      document.getElementById('jogSpeed').style.color = speedColor;
    }
    
    function resetJogPosition() {
      if (jogWheelData.debounceTimer) {
        clearTimeout(jogWheelData.debounceTimer);
      }
      jogWheelData = {
        position: 0,
        totalScrolls: 0,
        lastDirection: null,
        highestSpeed: 0,
        currentSeriesHighest: 0,
        debounceTimer: null
      };
      document.getElementById('jogPosition').textContent = '0';
      document.getElementById('jogProgress').style.strokeDashoffset = '502.65';
      document.getElementById('jogScrolls').textContent = '0';
      document.getElementById('jogDirection').textContent = '‚Äî';
      document.getElementById('jogDirection').style.color = '#333';
      document.getElementById('jogSpeed').textContent = '‚Äî';
      document.getElementById('jogSpeed').style.color = '#333';
      document.getElementById('jogHighestSpeed').textContent = '0';
      showToast('üîÑ Jog wheel position reset');
    }
    
    // Update scroll wheel visualization
    function updateScrollWheel(event) {
      // Update position
      scrollWheelData.position = event.position;
      scrollWheelData.totalScrolls++;
      scrollWheelData.lastDirection = event.direction;
      
      // Track highest speed in current series
      if (event.amount > scrollWheelData.currentSeriesHighest) {
        scrollWheelData.currentSeriesHighest = event.amount;
        scrollWheelData.highestSpeed = event.amount;
        document.getElementById('scrollHighestSpeed').textContent = event.amount;
      }
      
      // Clear existing debounce timer
      if (scrollWheelData.debounceTimer) {
        clearTimeout(scrollWheelData.debounceTimer);
      }
      
      // Set new debounce timer - reset series after 250ms of no movement
      scrollWheelData.debounceTimer = setTimeout(() => {
        scrollWheelData.currentSeriesHighest = 0;
      }, 250);
      
      // Update position text
      document.getElementById('scrollPosition').textContent = event.position;
      
      // Update vertical bar (center at 50%, goes up/down from there)
      // Normalize position to 0-100% range for visual
      const maxVisualRange = 500; // Visual range of ¬±500
      const normalizedPos = Math.max(-maxVisualRange, Math.min(maxVisualRange, event.position));
      const percentage = ((normalizedPos / maxVisualRange) * 50) + 50; // Convert to 0-100%
      document.getElementById('scrollProgress').style.height = percentage + '%';
      
      // Color based on position
      if (event.position > 0) {
        document.getElementById('scrollProgress').style.background = 'linear-gradient(to top, #52c41a, #91d5ff)';
      } else {
        document.getElementById('scrollProgress').style.background = 'linear-gradient(to top, #ff4d4f, #ffa39e)';
      }
      
      // Update stats
      document.getElementById('scrollScrolls').textContent = scrollWheelData.totalScrolls;
      document.getElementById('scrollDirection').textContent = event.direction === 'up' ? '‚Üë' : '‚Üì';
      document.getElementById('scrollDirection').style.color = event.direction === 'up' ? '#52c41a' : '#ff4d4f';
      
      // Update speed
      document.getElementById('scrollSpeed').textContent = event.amount;
      const speedColor = event.amount > 50 ? '#ff4d4f' : event.amount > 20 ? '#faad14' : '#52c41a';
      document.getElementById('scrollSpeed').style.color = speedColor;
    }
    
    function resetScrollPosition() {
      if (scrollWheelData.debounceTimer) {
        clearTimeout(scrollWheelData.debounceTimer);
      }
      scrollWheelData = {
        position: 0,
        totalScrolls: 0,
        lastDirection: null,
        highestSpeed: 0,
        currentSeriesHighest: 0,
        debounceTimer: null
      };
      document.getElementById('scrollPosition').textContent = '0';
      document.getElementById('scrollProgress').style.height = '50%';
      document.getElementById('scrollProgress').style.background = 'linear-gradient(to top, #52c41a, #91d5ff)';
      document.getElementById('scrollScrolls').textContent = '0';
      document.getElementById('scrollDirection').textContent = '‚Äî';
      document.getElementById('scrollDirection').style.color = '#333';
      document.getElementById('scrollSpeed').textContent = '‚Äî';
      document.getElementById('scrollSpeed').style.color = '#333';
      document.getElementById('scrollHighestSpeed').textContent = '0';
      showToast('üîÑ Scroll wheel position reset');
    }
    
    // Update log
    function updateLog(report) {
      const logDiv = document.getElementById('log');
      
      report.events.forEach((event, idx) => {
        const time = new Date(report.timestamp).toLocaleTimeString();
        const entryId = `log-${Date.now()}-${idx}`;
        let message = '';
        let className = event.type;
        let actions = '';
        
        if (event.type === 'button') {
          const isKnown = !event.name.startsWith('Unknown Button');
          if (isKnown) className += ' known';
          const checkmark = isKnown ? ' ‚úì' : '';
          
          // Show bit value if available (helps identify multiple buttons in same byte)
          const bitInfo = event.bitValue ? ` (bit: ${event.bitValue})` : '';
          message = `<span class="event-badge button">BUTTON</span> ${event.name}${checkmark} ${event.action.toUpperCase()}${bitInfo}`;
          
          // Only show "Add Mapping" for unknown buttons
          if (event.name.startsWith('Unknown Button')) {
            const byteInfo = event.bitValue ? `[byte ${event.byte}, value ${event.bitValue}]` : `[${event.byte}]`;
            const bitValueParam = event.bitValue || 'null';
            actions = `
              <div class="log-actions">
                <input type="text" id="${entryId}-name" placeholder="Enter button name..." 
                       onkeypress="if(event.key === 'Enter') quickAddButton(${event.byte}, '${entryId}-name', ${bitValueParam})" />
                <button onclick="quickAddButton(${event.byte}, '${entryId}-name', ${bitValueParam})">
                  ‚ûï Map Button ${byteInfo}
                </button>
              </div>
            `;
          } else {
            // Show confirmation for mapped buttons
            const mappingInfo = event.bitValue ? `byte ${event.byte}, bit ${event.bitValue}` : `byte ${event.byte}`;
            actions = `
              <div style="color: #52c41a; font-size: 12px; margin-top: 4px;">
                Mapped control (${mappingInfo})
              </div>
            `;
          }
        } else if (event.type === 'scroll') {
          const isKnown = !event.name.startsWith('Unknown Scroll');
          if (isKnown) className += ' known';
          const checkmark = isKnown ? ' ‚úì' : '';
          
          // Show raw velocity value if available
          const velocityInfo = event.rawValue ? ` [velocity: ${event.rawValue}]` : '';
          message = `<span class="event-badge scroll">SCROLL</span> ${event.name}${checkmark} ${event.direction.toUpperCase()} by ${event.amount}${velocityInfo} (pos: ${event.position})`;
          
          // Update jog wheel visualization if this is the jog wheel
          if (event.name === 'Jog' || event.name.includes('Jog')) {
            updateJogWheel(event);
          }
          
          // Update scroll wheel visualization if this is the scroll wheel
          if (event.name === 'Scroll' || event.name.includes('Scroll')) {
            updateScrollWheel(event);
          }
          
          // Only show "Add Mapping" for unknown scrolls
          if (event.name.startsWith('Unknown Scroll')) {
            actions = `
              <div class="log-actions">
                <input type="text" id="${entryId}-name" placeholder="Enter wheel name..." 
                       onkeypress="if(event.key === 'Enter') quickAddScroll(${event.byte}, '${entryId}-name')" />
                <button onclick="quickAddScroll(${event.byte}, '${entryId}-name')">
                  ‚ûï Map Scroll Wheel [${event.byte}]
                </button>
              </div>
            `;
          } else {
            // Show confirmation for mapped scrolls
            actions = `
              <div style="color: #52c41a; font-size: 12px; margin-top: 4px;">
                Mapped control (byte ${event.byte})
              </div>
            `;
          }
        } else if (event.type === 'value') {
          message = `<span class="event-badge value">VALUE</span> ${event.name}: ${event.prev} ‚Üí ${event.curr}`;
        }
        
        logEntries.unshift(`
          <div class="log-entry ${className}">
            <span class="timestamp">${time}</span> ${message}
            ${actions}
          </div>
        `);
      });
      
      // Keep only last MAX_LOG_ENTRIES
      logEntries = logEntries.slice(0, MAX_LOG_ENTRIES);
      logDiv.innerHTML = logEntries.join('');
    }
    
    // Toast notification
    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = 'toast';
      if (type === 'warning') toast.classList.add('warning');
      if (type === 'error') toast.classList.add('error');
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // Quick add functions
    async function quickAddButton(byte, inputId, bitValue = null) {
      const input = document.getElementById(inputId);
      const name = input.value.trim();
      
      if (!name) {
        showToast('‚ö†Ô∏è Please enter a button name', 'warning');
        input.focus();
        return;
      }
      
      // Use byte:bitValue as key if bitValue is provided (for multiple buttons on same byte)
      const key = bitValue ? `${byte}:${bitValue}` : byte;
      
      // Update local config
      config.buttons[key] = name;
      renderMappings();
      
      // Auto-save to server so future events use this mapping
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      });
      
      // Clear the input
      input.value = '';
      input.style.border = '2px solid #52c41a';
      setTimeout(() => {
        input.style.border = '1px solid #555';
      }, 1000);
      
      // Show success message
      const keyInfo = bitValue ? `[byte ${byte}, bit ${bitValue}]` : `[${byte}]`;
      showToast(`‚úÖ Button ${keyInfo} ‚Üí "${name}" (saved & active!)`);
    }
    
    async function quickAddScroll(byte, inputId) {
      const input = document.getElementById(inputId);
      const name = input.value.trim();
      
      if (!name) {
        showToast('‚ö†Ô∏è Please enter a wheel name', 'warning');
        input.focus();
        return;
      }
      
      // Update local config
      config.scrollWheels[byte] = name;
      renderMappings();
      
      // Auto-save to server so future events use this mapping
      await fetch('/api/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
      });
      
      // Clear the input
      input.value = '';
      input.style.border = '2px solid #52c41a';
      setTimeout(() => {
        input.style.border = '1px solid #555';
      }, 1000);
      
      // Show success message
      showToast(`‚úÖ Scroll [${byte}] ‚Üí "${name}" (saved & active!)`);
    }
    
    function clearLog() {
      logEntries = [];
      document.getElementById('log').innerHTML = '';
      showToast('üóëÔ∏è Log cleared');
    }
  </script>
</body>
</html>
